generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
}

enum EnrollmentStatus {
  ATIVA
  PENDENTE
  ENCERRADA
}

enum DiscountType {
  PERCENTUAL
  FIXO
}

enum RevenueCategory {
  MATRICULA
  MENSALIDADE
  PARCELAMENTO
  TAXA_EXTRA
  PAGAMENTO_AVULSO
  OUTRAS_RECEITAS
}

enum ExpenseCategory {
  SALARIOS
  ALUGUEL
  MATERIAIS
  AGUA_LUZ_INTERNET
  MARKETING
  MANUTENCAO
  OPERACIONAL
  OUTROS
}

enum PaymentStatus {
  PENDENTE
  PAGO
  ATRASADO
}

enum ReportType {
  MENSAL
  ANUAL
  LUCRO_PREJUIZO
  RECEITAS_POR_PERIODO
  FLUXO_CAIXA
  INADIMPLENCIA
}

model User {
  id           String      @id @default(cuid())
  name         String
  email        String      @unique
  role         UserRole    @default(ADMIN)
  passwordHash String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  logs         SystemLog[]
}

model Student {
  id                 String              @id @default(cuid())
  fullName           String
  registrationNumber String              @unique
  email              String?
  active             Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  enrollments        Enrollment[]
  tuitions           Tuition[]
  receivables        AccountReceivable[]
  revenues           Revenue[]
}

model Scholarship {
  id          String       @id @default(cuid())
  name        String
  type        DiscountType
  amount      Decimal
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  enrollments Enrollment[]
  tuitions    Tuition[]
}

model Discount {
  id          String       @id @default(cuid())
  name        String
  type        DiscountType
  amount      Decimal
  active      Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  enrollments Enrollment[]
  tuitions    Tuition[]
}

model Enrollment {
  id            String            @id @default(cuid())
  studentId     String
  scholarshipId String?
  discountId    String?
  status        EnrollmentStatus  @default(ATIVA)
  startDate     DateTime
  endDate       DateTime?
  amount        Decimal
  installments  Int               @default(1)
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  student       Student           @relation(fields: [studentId], references: [id])
  scholarship   Scholarship?      @relation(fields: [scholarshipId], references: [id])
  discount      Discount?         @relation(fields: [discountId], references: [id])
  tuitions      Tuition[]
  revenues      Revenue[]

  @@index([studentId])
  @@index([status])
}

model Tuition {
  id                 String         @id @default(cuid())
  studentId          String
  enrollmentId       String?
  scholarshipId      String?
  discountId         String?
  referenceMonth     DateTime
  amount             Decimal
  discountApplied    Decimal?
  scholarshipApplied Decimal?
  dueDate            DateTime
  paidAt             DateTime?
  status             PaymentStatus  @default(PENDENTE)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  student            Student        @relation(fields: [studentId], references: [id])
  enrollment         Enrollment?    @relation(fields: [enrollmentId], references: [id])
  scholarship        Scholarship?   @relation(fields: [scholarshipId], references: [id])
  discount           Discount?      @relation(fields: [discountId], references: [id])

  @@index([studentId])
  @@index([referenceMonth])
  @@index([status])
}

model Revenue {
  id            String          @id @default(cuid())
  category      RevenueCategory
  description   String
  amount        Decimal
  receivedAt    DateTime
  referenceMonth DateTime
  paymentMethod String?
  studentId     String?
  enrollmentId  String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  student       Student?        @relation(fields: [studentId], references: [id])
  enrollment    Enrollment?     @relation(fields: [enrollmentId], references: [id])

  @@index([referenceMonth])
  @@index([category])
}

model Expense {
  id            String          @id @default(cuid())
  category      ExpenseCategory
  description   String
  amount        Decimal
  dueDate       DateTime
  paidAt        DateTime?
  status        PaymentStatus   @default(PENDENTE)
  vendor        String?
  paymentMethod String?
  recurringBillId String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  recurringBill RecurringBill?  @relation(fields: [recurringBillId], references: [id])

  @@index([dueDate])
  @@index([category])
  @@index([status])
}

model RecurringBill {
  id          String          @id @default(cuid())
  name        String
  category    ExpenseCategory
  amount      Decimal
  dayOfMonth  Int
  active      Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  expenses    Expense[]

  @@index([active])
}

model AccountReceivable {
  id            String        @id @default(cuid())
  studentId     String?
  description   String
  amount        Decimal
  dueDate       DateTime
  paidAt        DateTime?
  status        PaymentStatus @default(PENDENTE)
  referenceMonth DateTime
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  student       Student?      @relation(fields: [studentId], references: [id])

  @@index([referenceMonth])
  @@index([status])
}

model AccountPayable {
  id            String          @id @default(cuid())
  category      ExpenseCategory
  vendor        String
  description   String
  amount        Decimal
  dueDate       DateTime
  paidAt        DateTime?
  status        PaymentStatus   @default(PENDENTE)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([dueDate])
  @@index([status])
}

model Report {
  id          String     @id @default(cuid())
  type        ReportType
  periodStart DateTime
  periodEnd   DateTime
  data        Json
  createdAt   DateTime   @default(now())
}

model SystemLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([createdAt])
}

model FinancialSettings {
  id                  String   @id @default(cuid())
  emergencyReserve    Decimal  @default(0)
  emergencyReserveGoal Decimal @default(0)
  updatedAt           DateTime @updatedAt
}
